<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Portal - Working</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .card { background: white; border-radius: 15px; padding: 30px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .status { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        input, button { padding: 12px; margin: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        input { width: 250px; }
        button { background: #007bff; color: white; cursor: pointer; border: none; font-weight: bold; transition: all 0.3s; }
        button:hover { background: #0056b3; transform: translateY(-2px); }
        .section { margin: 20px 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .result { margin-top: 15px; padding: 10px; border-radius: 5px; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ Unified Government Portal</h1>
            <p>Complete Authentication System</p>
            <p>API Status: <span id="status">Loading...</span></p>
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>ğŸ” Login System</h3>
                <div class="section">
                    <input type="email" id="email" placeholder="Email Address" value="test@example.com">
                    <input type="password" id="password" placeholder="Password" value="test123">
                    <br>
                    <button onclick="login()">ğŸšª Login</button>
                    <button onclick="logout()">ğŸš¶ Logout</button>
                </div>
                <div id="login-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>ğŸ‘¤ User Profile</h3>
                <div class="section">
                    <button onclick="getProfile()">ğŸ“‹ Get My Profile</button>
                    <button onclick="getServices()">ğŸ› ï¸ Get Services</button>
                </div>
                <div id="profile-result" class="result"></div>
            </div>
            
            <div class="card">
                <h3>ğŸ“ New Registration</h3>
                <div class="section">
                    <input type="text" id="reg-name" placeholder="Full Name" value="New User">
                    <input type="email" id="reg-email" placeholder="Email" value="newuser@test.com">
                    <input type="tel" id="reg-mobile" placeholder="Mobile (10 digits)" value="9999999999">
                    <input type="password" id="reg-password" placeholder="Password" value="test123">
                    <br>
                    <button onclick="register()">âœ… Register New User</button>
                </div>
                <div id="register-result" class="result"></div>
            </div>
        </div>
    </div>
    
    <script>
        let authToken = localStorage.getItem('authToken');
        
        // Test API health
        fetch('/api/health')
            .then(r => r.json())
            .then(data => {
                document.getElementById('status').innerHTML = 
                    '<span class="status">' + data.status + ' - ' + data.message + '</span>';
            })
            .catch(e => {
                document.getElementById('status').innerHTML = 
                    '<span class="error">Error: ' + e.message + '</span>';
            });
        
        // Login function
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            fetch('/api/auth/login', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(r => {
                if (!r.ok) throw new Error('Login failed: ' + r.status);
                return r.json();
            })
            .then(data => {
                if (data.access_token) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    document.getElementById('login-result').innerHTML = 
                        'âœ… Login successful! Token: ' + data.access_token.substring(0, 20) + '...';
                    document.getElementById('login-result').className = 'result success';
                } else {
                    throw new Error('No token received');
                }
            })
            .catch(e => {
                document.getElementById('login-result').innerHTML = 
                    'âŒ Login failed: ' + e.message;
                document.getElementById('login-result').className = 'result error';
            });
        }
        
        // Logout function
        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('login-result').innerHTML = 'âœ… Logged out successfully';
            document.getElementById('login-result').className = 'result success';
            document.getElementById('profile-result').innerHTML = '';
        }
        
        // Get profile function
        function getProfile() {
            if (!authToken) {
                document.getElementById('profile-result').innerHTML = 'âŒ Please login first';
                document.getElementById('profile-result').className = 'result error';
                return;
            }
            
            fetch('/api/auth/me', {
                headers: { 'Authorization': 'Bearer ' + authToken }
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('profile-result').innerHTML = 
                    'âœ… Profile:<br>' + JSON.stringify(data, null, 2);
                document.getElementById('profile-result').className = 'result success';
            })
            .catch(e => {
                document.getElementById('profile-result').innerHTML = 
                    'âŒ Profile fetch failed: ' + e.message;
                document.getElementById('profile-result').className = 'result error';
            });
        }
        
        // Get services function (placeholder)
        function getServices() {
            const services = [
                {id: "electricity", name: "Electricity", icon: "âš¡"},
                {id: "gas", name: "Gas", icon: "ğŸ”¥"},
                {id: "water", name: "Water", icon: "ğŸ’§"},
                {id: "property", name: "Property", icon: "ğŸ "}
            ];
            
            document.getElementById('profile-result').innerHTML = 
                'âœ… Available Services:<br>' + JSON.stringify({services}, null, 2);
            document.getElementById('profile-result').className = 'result success';
        }
        
        // Register function
        function register() {
            const full_name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const mobile = document.getElementById('reg-mobile').value;
            const password = document.getElementById('reg-password').value;
            
            if (!full_name || !email || !mobile || !password) {
                document.getElementById('register-result').innerHTML = 'âŒ All fields are required';
                document.getElementById('register-result').className = 'result error';
                return;
            }
            
            fetch('/api/auth/register', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ full_name, email, mobile, password, city: "Test City" })
            })
            .then(r => {
                if (!r.ok) throw new Error('Registration failed: ' + r.status);
                return r.json();
            })
            .then(data => {
                document.getElementById('register-result').innerHTML = 
                    'âœ… Registration successful!<br>User ID: ' + data.id + '<br>Email: ' + data.email;
                document.getElementById('register-result').className = 'result success';
            })
            .catch(e => {
                document.getElementById('register-result').innerHTML = 
                    'âŒ Registration failed: ' + e.message;
                document.getElementById('register-result').className = 'result error';
            });
        }
        
        // Auto-login if token exists
        if (authToken) {
            getProfile();
        }
    </script>
</body>
</html>